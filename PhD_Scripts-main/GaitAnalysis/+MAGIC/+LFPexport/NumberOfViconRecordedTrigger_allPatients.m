                                            clear all
%Verification essais nombre trigger enregistrés par vicon
Patients = {'FEp','DEp','FRa','ALb','FRJ','SOh','VIj','GUG','BARGU14','COm','BEm','DROCA16','GIs','LOp','DESJO20','REa',};
CondMed = {'OFF','ON'};
                                            cnt = 0;
                                            disp(['Nombre de patients : '  num2str(length(Patients))])
%    'SAs',
for p = 1:length(Patients)
for condonofff = 1:2 
    Patient = Patients{p};   
    Cond = CondMed{condonofff};          
    Session = 'POSTOP';
    disp(['Patient = ' Patients{p} '  n°' num2str(p) ' ' Cond])
    num_trial_omission = {};
% Essais
    
     if strcmp(Patient, 'BARGU14')
        Type = 'GOGAIT'; %'GOGAIT','MAGIC';
        Date = '000'; % check date
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial = {'08','09','10','11','12','13','15','16','18','19','21','23','24','26','30','31','32','34','37','39','43','45','48','51','52','53','54','55','57','58','59','60'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
                num_trial_NoGo_OK = {'14','17','20','25','33','35','36','38','40','41', '44','46','47','49','50'};
                num_trial_NoGo_Bad = {'22','27','28','29', '42'};
            elseif strcmp(Cond, 'ON')
                num_trial = {'01','02','03','04','05','06','07','08','09','10','13','14','18','19','23','25','27','30','31','32','35','38','39','42','44','45','46','48','49','50','51','52','53','54','55','56','57','58','59','60'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
                num_trial_NoGo_OK = {'11','12','15','16','17','20','21','22','24','26','28','29','33','34','36','37','40','41','43','47'};
                num_trial_NoGo_Bad = {};
            end
        end
   
% BENMO
    elseif strcmp(Patient, 'BEm')
        Type = 'GBMOV'; %'GOGAIT','MAGIC';
        Date = '2019_10_03';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial = {'001','003','006','007','008','009','010','014','015','017','020','024','026','027','028','030','031','034','036','039','041','042','043','045','046','048','049','051','052','053','054','055','056','057','058','059','060'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
                num_trial_NoGo_OK = {'011','013','016','018','019','021','022','023','025','029','032','033','035','037','038','040','044','047','050'};
                num_trial_NoGo_Bad = {'012'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'011','012','013','017','020','021','023','026','028','030','034','035','036','038','040','041','043','044','046','047'};
                num_trial_NoGo_Bad = {};
                num_trial = {'001','002','003','004','005','006','007','008','009','010','014','015','016','018','019','022','024','025','027','029','031','032','033','037','039','042','045','048','049','050','051','052','053','054','055','056','057','058','059','060'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end          

 % COUMA
    elseif strcmp(Patient, 'COm')
        Type = 'GBMOV'; %'GOGAIT','MAGIC'
        Date = '2019_10_24';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'011', '013', '018','019', '021', '025' ,'029','032','033', '035', '037','038', '040', '044', '047','050'};
                num_trial_NoGo_Bad = {'012', '016', '022','023',};
                num_trial = {'002','003','004','005','006','007','008','009','010','014','015','017','020','024','026','027','028','030','031','034','036','039','041','042','043','045','046','048','049','051','052','053','054','055','056','057','059','060'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'011','012', '017', '020','021', '023', '026', '028', '030', '034','035','036', '038', '044', '046','047'};
                num_trial_NoGo_Bad = {'013','040','041', '043'};
                num_trial = {'001','002','003','004','005','006','007','009','010','014','015','016','018','019','022','024','025','027','031','033','039','042','045','048','049','050','051','052','053','054','055','056','057','059','060'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end
% DESJO20
    elseif strcmp(Patient, 'DESJO20')
        Type = 'GOGAIT'; %'GOGAIT','MAGIC'
        Date = '000'; % check date
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'11','13','17','19','20','21','25','29','30','33','35','36','37','39','40','44','45','47','48','49'};
                num_trial_NoGo_Bad = {};
                num_trial = {'01','02','03','04','05','06','07','08','10','12','14','15','16','18','22','23','24','26','27','28','31','32','34','38','41','42','43','46','50','51','52','53','54','55','56','57','58','59','60'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'14','17','20','22','25','27','28','29','33','35','36','38','40','41','42','44','46','47', '49','50'};
                num_trial_NoGo_Bad = {};
                num_trial = {'01','02','03','04','05','06','07','08','10','11','12','13','16','18','19','21','23','24','30','31','32','34','37','43','45','51','52','53','54','55','56','57','58','59','60'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end 
 
 % DROCA16
    elseif strcmp(Patient, 'DROCA16')
        Date = '000'; % check date
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                Type = 'GAITPARK' ;
                num_trial_NoGo_OK = {'14','17','21','22','29','30','33','36','39','40','44','47','48'};
                num_trial_NoGo_Bad = {'13','24','27','35','37','43','46'};
                num_trial = {'01','02','03','04','05','06','07','08','09','10','11','12','15','16','18','19','20','23','25','26','28','31','32','34','41','42','45','49','50','51','52','53','54','55','56','57','58','59','60'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                Type = 'GOGAIT'; 
                 num_trial_NoGo_OK = {'15','18','33','34','38','42','46'}; 
                num_trial_NoGo_Bad = {'11','12','17','20','21','22','24','28','29','31','36','43','50'}; 
                num_trial = {'01','02','03','05','06','07','08','09','10','13','14','16','19','23','25','26','27','30','32','35','37','39','40','41','44','45','47','48','49','51','52','53','54','55','56','57'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end
          
  % GIRSA40
    elseif strcmp(Patient, 'GIs')
        Type = 'GBMOV'; %'GOGAIT','MAGIC'
        Date = '2020_07_02';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'011','012','015','016','017','021','022','024','026','028','033','034','036','037','040','041','043','047'};
                num_trial_NoGo_Bad = {'020','029'};
                num_trial = {'001','002','003','004','005','006','007','008','009','010','013','014','018','019','023','025','027','030','031','032','035','038','039','042','044','045','046','048','049','051','052','053','054','055','056','057','058','059','060'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'014','016','017','021','022','025','026','029','033','036','037','039','040','042','044','045','047'};
                num_trial_NoGo_Bad = {'011','013','023'};
                num_trial = {'001','002','003','004','005','006','008','009','010','012','015','018','019','020','024','027','028','030','031','032','034','035','038','041','043','046','048','049','050','051','052','053','054','055','056','057','058','059'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end
        % LOUPH38
    elseif strcmp(Patient, 'LOp')
        Type = 'GBMOV'; %'GOGAIT','MAGIC'
        Date = '2019_11_28';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                 num_trial_NoGo_OK = {'016','019','025','026','028','030','031','042','044','047','049'};
                num_trial_NoGo_Bad = {'012','017','022','032','034','037','039','048'};
                num_trial = {'001','002','003','004','005','006','007','008','009','010','013','014','015','018','020','021','023','024','027','029','040','041','043','045','046','050','051','052','053','054','055','056','057','058','059'}; 
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'027','029','031','034','036','039','040','041','042','045' '048'};
                num_trial_NoGo_Bad = {'011', '013', '017', '043'};
                num_trial = {'001','002','003','008','010','014','018','019','020','022','023','025','026','028','030','035','037','038','044','046','049','050','051','052','053','054','055','056','057','058'}; 
            end
        end
 % DEp01
    elseif strcmp(Patient, 'DEp')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2020_01_16';                                  
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF') 
                num_trial_NoGo_OK = {'011','013','017','019','020','021','025','030','033','035','036','037','039','040','044','047','048','049'};
                num_trial_NoGo_Bad = {'029','045'};
                num_trial = {'001','002','003','004','005','006','007','008','009','010','012','014','015','016','018','022','023','024','026','027','028','031','032','034','038','041','042','043','046','050','051','052','053','055','056','057','058','059','060'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'014','017','020','022','025','027','028','029','033','035','036','038','040','042','044','046','047','049','050'};
                num_trial_NoGo_Bad = {'041'};
                num_trial = {'001','003','004','005','006','007','008','009','011','012','013','015','016','018','019','021','023','024','030','031','032','034','037','039','048','051','052','053','055','057','058'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end
 % FEp02
    elseif strcmp(Patient, 'FEp')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2020_02_20'; 
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'012','016','017','019','022','025','026','028','030','031','032','037','039','040','043','045','048','050'};
                num_trial_NoGo_Bad = {'034','049'};
                num_trial = {'001','002','003','004','005','006','007','008','009','010', '011','013','014','015','018','020','021','023','024','027','029','033','035','036','038','041','042','044','046','047','052','053','054','055','056','057','059','060'}; 
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'011','013','017','018','023','033','034','041','042','049','050'};
                num_trial_NoGo_Bad = {'014','019','026','029','031','036','038','043','045'};
                num_trial = {'001','002','003','004','005','006','007','008','009','010', '012','015','016','020','021','022','024','025','027','028', '030','032','035','037','039','040','044','046','047','048', '051','052','053','054','055','056','057','058','059','060'};
            end
        end       
 % ALb03
    elseif strcmp(Patient, 'ALb')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2020_06_25'; 
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'013','015','016','017','021','027','028','031','032','035','039','040','042','043','044','046','047','048'};
                num_trial_NoGo_Bad = {'011','025'};
                num_trial = {'001','002','004','005','007','008','009','012','014','018','020','023','026','029','030','033','034','036','038','041','045','050','053','054','055'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'022','043','045','047'};
                num_trial_NoGo_Bad = {'011','012','014','015','016','018','019','024','025','026','029','028','033','037','038','040'}; 
                num_trial = {'001','002','005','006','007','008','009','013','017','020','021','032','034','036','041','042','044','049','051','052'};
            end
        end
% GAl04
    elseif strcmp(Patient, 'GAl')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2020_09_17';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'011','012','015','017' ,'020','021','022', '024', '026', '028','029'};
                num_trial_NoGo_Bad = {'016'};
                num_trial = {'001','002','003','004','005','006','007','008','009','010','013','014','018','019','025','027','031','032'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'011', '013','014', '016','017', '021','022' ,'025','026', '029','033','036','037','039','040','042','044','045', '047'};
                num_trial_NoGo_Bad = { '023'};
                num_trial = {'001','002','003','004','006','007','008','009','010','012','015','018','019','020','024','027','028','031','032','034','035','038','041','043','046','048','050','051','052','053','054','055','056','057','058','059','060'};
            end
        end        
 % SOh
    elseif strcmp(Patient, 'SOh')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2020_10_08';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'011','015','017','020','022','024','028','029','033','034','036','037','040','041','043','047','115','116','117','120'};
                num_trial_NoGo_Bad = {'012','016','021','026'};
                num_trial = {'013','014','018','019','023','025','027','030','031','032','035','038','039','042','044','045','048','049','050','051','052','053','054','055','056','057','058','059','060','101','102','103','104','105','106','107','108','109','110','113','114'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'013','014','016','017','021','022','023','025','026','029','036','037','039','044','045','047'};
                num_trial_NoGo_Bad = {'011','033','040','042'};
                num_trial = {'001','002','003','004','005','006','007','008','009','010','012','015','018','019','020','024','027','028','030','031','032','034','035','038','041','043','048','049','050','051','052','053','054','055','056','057','058','060'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end
% VIj
    elseif strcmp(Patient, 'VIj')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2021_04_01';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'011','013','017','019','020','021','025','029','030','033','035','036','037'};
                num_trial_NoGo_Bad = {};
                num_trial = {'002','003','004','005','006','007','008','009','010','012','014','015','016','018','022','023','024','026','027','028','031','032','034'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {'014','020','022','025','027','028','035','038','040','042','044','046','047','049','050'};
                num_trial_NoGo_Bad = {'017','029','033','036','041'};
                num_trial = {'001','002','003','004','005','006','007','008','009','010','011','012','013','015','016','018','019','021','023','024','026','030','031','032','034','037','039','043','048','051','052','053','054','055','056','057','058','059','060'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end
        

    % P01Rouen
    elseif strcmp(Patient, 'GUG')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2020_11_30';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {};
                num_trial_NoGo_Bad = {};
                num_trial = {'001','002','003','004',...
                    '005','007','008','009','010',...
                    '011','012','015','016'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {};
                num_trial_NoGo_Bad = {};
                num_trial = {'002','004','006','007','010',...
                    '011','013','015','023','030',...
                    '034','037','039','047','048',...
                    '054','056','057','059','060'};
            end
        end
        
    % P02Rouen 
    elseif strcmp(Patient, 'FRJ')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2021_02_08';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {};
                num_trial_NoGo_Bad = {};
                num_trial = {'001','004','005','006','010',...
                    '015','024','030','034',...
                    '039','041','042','043','048','049',...
                    '052','054','056','058','060'} ;
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {};
                num_trial_NoGo_Bad = {};
                num_trial = {'002','004','005','008','009',...
                    '014','018','024','025','031',...
                    '033','039','042','045','049',...
                    '052','053','055','057','059'};
            end
        end

    % P03Rouen
    elseif strcmp(Patient, 'FRa')
        Type = 'MAGIC'; %'GOGAIT','MAGIC'
        Date = '2021_10_04';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {};
                num_trial_NoGo_Bad = {};
                num_trial = {'001','002','003','004','005','006','007'}; %{'01','02','03','04','06','07','08','09','10','12','13','14','15','16','17','18','19','20'};
            elseif strcmp(Cond, 'ON')
                num_trial_NoGo_OK = {};
                num_trial_NoGo_Bad = {};
                num_trial = {'002','003','006','007','008','052','053','057','059','060'}; %{'01','02','03','04','05','06','09','14','15','16','19'};
            end
        end
        
     % REMAL39
     elseif strcmp(Patient, 'REa')
        Type = 'GBMOV'; %'GOGAIT','MAGIC'
        Date = '2020_01_09';
        if strcmp(Session, 'POSTOP')
            if strcmp(Cond, 'OFF')
                num_trial_NoGo_OK = {'011','012','015','016','017','020','021','022','026','028','029','033','034','036','037','040','041','043'};
                num_trial_NoGo_Bad = {'024'};
                num_trial = {'001','002','003','004','005','006','007','008','009','013','014','018','019',...
                    '023','025','027','030','031','032','035','038','039','042','044','045','046',...
                    '048','049','050','051','052','053','054','055','056','057','058','059','060'};
            elseif strcmp(Cond, 'ON')
                num_trial = {}; % AUCUN ESSAI EN ON
                num_trial_NoGo_OK = {};
                num_trial_NoGo_Bad = {};
            end   
        end   
 
     end
     
     
     
num_trial(length(num_trial)+1:(length(num_trial)+length(num_trial_NoGo_Bad))) =  num_trial_NoGo_Bad ;
num_trial(length(num_trial)+1:length(num_trial)+length(num_trial_NoGo_OK)) =  num_trial_NoGo_OK ;

for nt = 1:length(num_trial) % Boucle num_trial


%%
% ___Chargement fichier___________________________________________________________

% Nom de l'essai à charger
if strcmp(Type,'GOGAIT') | strcmp(Type,'GAITPARK')
    filename = [ Type '_'  Session '_'  Patient  '_'  Cond '_GNG_' num_trial{nt} '.c3d'];
else
    if strcmp(Patient,'GUG') | strcmp(Patient,'FRJ') | strcmp(Patient,'FRa')
        filename = ['ParkRouen_' Date '_'  Patient  '_' Type '_'  Session '_' Cond '_GNG_GAIT_' num_trial{nt} '.c3d'];
    else
        filename = ['ParkPitie_' Date '_'  Patient  '_' Type '_'  Session '_' Cond '_GNG_GAIT_' num_trial{nt} '.c3d'];
    end
end

cd(['\\lexport\iss01.pf-marche\temp\temp\LINKERS_Logfiles\DATA_old\' Patient ]);
h= btkReadAcquisition(filename);
Fs = btkGetPointFrequency(h); % fréquence d'acquisition des caméras
Times  = (0:btkGetLastFrame(h)-btkGetFirstFrame(h))/btkGetPointFrequency(h); % timeline de l'enregistrement
n  = length(Times);


%%
% ___Traitement du fichier___________________________________________________________

DATA.TrialName = filename(1:end-4);        %enleve le ".c3d"
DATA.Patient = Patient;
DATA.Session = Session;
DATA.TrialNum = num_trial{nt} ;
DATA.Cond = Cond; 
% Delai cue
frameAna = btkGetAnalogFrequency(h);
voltTrigger= btkGetAnalog(h, 'Voltage.Trigger');
peakVoltTrig = {};
voltTrigger = normalize(voltTrigger,'range') ; 
for i = 1:length(voltTrigger)
    if voltTrigger(i) > 0.7 ; voltTrigger(i) = 1 ;
    else ; voltTrigger(i) = 0 ; end ; end
i=1; while i < 3.7* frameAna ; i=i+1 ;
    if voltTrigger(i) ~= voltTrigger(i-1) 
        peakVoltTrig{end+1}=i/frameAna; end ; end
DATA.CUE = peakVoltTrig{end};
DATA.FIX = peakVoltTrig{end-2};
DATA.TriggerNumber = length (peakVoltTrig);
DATA.AllPeaks = cell2mat(peakVoltTrig);


cnt = cnt+1;
TRIGGER.DATA(cnt) = DATA;
clearvars -except cpt cpt2 TRIGGER CondMed cnt condonofff filename num_trial_NoGo_OK num_trial_NoGo_Bad Times Fs n h Patient Patients p  Session num_trial nt Cond Ev MARCHE Date Type listFOG % Trajectoires Events2

end
    
    
    
    
end 
end



cd('\\lexport\iss01.pf-marche\temp\temp\LINKERS_Logfiles\test');
[nom_fich,chemin] = uiputfile('*.mat','Nom Du fichier à sauvegarder',[ 'Trigger_log']); % CHECKER LE NOM %HereChange


% Export Matlab
if any(nom_fich ~= 0)
    nom_fich2 =nom_fich;
    eval([nom_fich(1:end-4) '= TRIGGER;'])
    eval(['save(nom_fich(1:end-4), nom_fich(1:end-4));'])
    writetable(struct2table(TRIGGER.DATA), [nom_fich2(1:end-4) '.xlsx'])
    disp('mat et xlsx sauvegardés');
end

%% More verification 
        moreverif=False ; if moreverif==True
        for i = 1:60 ; eval(['moy' num2str(i) '= {};' ]) ; end
        for i = 101:114 ; eval(['moy' num2str(i) '= {};' ]) ;end
        for u = 1:960 ; alpha = {TRIGGER.DATA.TrialNum}; alpha = str2double(alpha); 
            if TRIGGER.DATA(u).TriggerNumber == 5 ; eval(['moy' num2str(alpha) '{end+1} = TRIGGER.DATA(u).FIX;' ]) ; end ; end
        for i = 1:60 ; eval(['moyres.da(1,' num2str(i) ')= mean(cell2mat(moy' num2str(i) '));' ]) 
            moyres.da(2,i)=i; end
        plot(moyres.da(1,:)) ; end

clear all